<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>资源管理</title>
    <link rel="stylesheet" href="/commonstatic/base/css/base_blue.css">
    <link rel="stylesheet" href="../css/resourchAd.css">
    <link rel="stylesheet" href="../css/useManage.css">
    <link rel="stylesheet" href="/commonstatic/plugin/page/css/table_blue.css">
    <link rel="stylesheet" href="/commonstatic/plugin/treeview/jquery.treeview.css" />
    <link rel="stylesheet" href="/commonstatic/plugin/treeview/screen.css" />
    <link rel="stylesheet" type="text/css" href="/commonstatic/plugin/popup/css/manhuaDialog.1.0.css">
    <link rel="stylesheet" href="/commonstatic/plugin/tip/css/tip-twitter/tip-twitter.css">
    <script src='/commonstatic/base/js/jquery.js'></script>
    <script src="/commonstatic/base/js/docassistant.js"></script>
    <script src="/commonstatic/base/js/public.js"></script>
    <script src="/commonstatic/base/js/reqConfig.js"></script>

    <script src="/commonstatic/plugin/tip/script/jquery.poshytip.js"></script>
    <script src="/commonstatic/base/js/validate.js"></script>
    <script src='/commonstatic/plugin/page/script/jquery.page.js'></script>
    <script src="/commonstatic/plugin/treeview/lib/jquery.cookie.js" type="text/javascript"></script>
    <script src="/commonstatic/plugin/treeview/jquery.treeview.js" type="text/javascript"></script>
    <script src="/commonstatic/plugin/popup/script/manhuaDialog.1.0.js" type="text/javascript"></script>
    <script src="../js/chooseOrganization.js"></script>
    <style>  
    .domTreeActive {font-size:16px;}

    .userNewPopup-ulist-list-input{
        display:inline-block;width: 150px; box-shadow: 2px 2px 4px rgba(143, 146, 148, 0.15); height: 28px; padding-left: 5px;line-height:28px;border:0px;
    }

    </style>
    <script>
        var globalFunctionId = "";
        var orgId = GetQueryString("orgId");//组织id
        var orgName = decodeURI(GetQueryString("orgName"));//组织名称====中文转义
        $(function(){


            /***************************选择组织开始*************************/
            if(!orgId){//弹出选择组织框
                getAjaxResult("/orgInfo/getListRecursionOrgInfo","POST",{"id":""},"initZz(data)")
            }else{//显示当前用户下挂载的组织信息

                //初始化加载domtree
                initTree(orgId);
            }

            $("#czSureBtn").click(function(){//选择组织确认按钮
                // if(!$("#looptree2 a").hasClass("domTreeActive")){//未选择组织

                // }
                //初始化加载domtree
                initTree(orgId);
                closePopupWin();
            });
            $("#czCancelBtn").click(function(){//选择组织确认按钮
                ("#czSureBtn").click();
            });
            $("#looptree2 .cloneTreeA").click(function(){
                //$(this).
                //$(this).parent()[0].data.id   $(this).parent()[0].data.orgName

                $("#looptree2 a").removeClass("domTreeActive");
                $(this).addClass("domTreeActive");

                orgId = $(this).parent()[0].data.id;
                orgName = $(this).parent()[0].data.orgName;

            });
            /***************************选择组织结束*************************/
           

            //root
            $("#root").click(function(){
                $(".resourceAd-con-left a").removeClass("domTreeActive");
                $(this).addClass("domTreeActive");
                $("#createNewPermission").show();
                $("#detailRow").hide();
                $("#deletePermission").hide();
                $("#editPermission").hide();
                $("#detailRow")[0].data = null;
            });



            /************************新建权限开始*****************************/
            $("#creatPermi").click(function(){//新建权限 =>确认
                initValidate($("#resourchSe")[0]);
                var obj = new clsValidateCtrl();  
                if(obj.validateAll())
                {
                    if($("#resourchSe #status").prop("checked")){
                        var status = 1
                    }else{
                        var status = 0;
                    }
                    if($("#resourchSe h2").html() == "新建权限" ){//新建
                        var reqParam = {"functionTitle":$("#resourchSe #functionTitle").val(),"opt":"insert","orgId":orgId,"parentApplicationId":"","status":$("#resourchSe #status").prop("checked"),"functionPath":$("#resourchSe #functionPath").val(),"status":status};
                        if($("#detailRow")[0].data){
                            reqParam.parentApplicationId = $("#detailRow")[0].data.functionId;
                        }
                        // /functionManage/keepFunctionManage
                        getAjaxResult("/functionManage/keepFunctionManage", "post", reqParam, 'delOrSavePermission(data)');
                    }else{//编辑

                        var data = $("#detailRow")[0].data;
                        var reqParam = {};
                        if(data){
                            reqParam = {"functionTitle":$("#resourchSe #functionTitle").val(),"functionPath":$("#resourchSe #functionPath").val(),"opt":"update","orgId":orgId,"functionId":data.functionId,"status":status}
                        };
                        //globalFunctionId = $("#detailRow")[0].data.functionId;
                        getAjaxResult("/functionManage/keepFunctionManage", "post", reqParam, 'delOrSavePermission(data)');
                    }

                }


            })
            $("#cancelPermi").click(function(){//取消创建权限
                closePopupWin()
            })

            $("#addPermission").click(function(){//暂无权限，新增权限
                openWin(400, 300, "resourchSe", true);
                $("#resourchSe h2").html("新建权限");
            });
            $("#createNewPermission").click(function(){//新增下级权限
                openWin(400, 300, "resourchSe", true);
                $("#resourchSe h2").html("新建权限");

                //复现初始化组织信息
                //showOrganization($("#detailRow")[0].data);
                

            });
            /************************新建权限结束*****************************/



            /***********************编辑权限开始****************************/
            $("#editPermission").click(function(){//编辑当前权限
                openWin(400, 300, "resourchSe", true);
                $("#resourchSe h2").html("编辑权限");
                setValue4Desc($("#detailRow")[0].data, $("#resourchSe")[0]);

                //复现初始化组织信息
                //showOrganization($("#detailRow")[0].data);
            });
            
            $("#cancelPermiEdit").click(function(){//取消权限修改
                closePopupWin()
            })
            /***********************编辑权限结束****************************/
            /**************************启用权限开始*****************************/
            $("#detailRow #status").click(function(){
                if($("#detailRow #status").prop("checked")){
                    var status = 1;
                }else{
                    var status = 0;
                }
                reqParam = {"opt":"update","functionId":$("#detailRow")[0].data.functionId,"status":status}
                getAjaxResult("/functionManage/keepFunctionManage", "post", reqParam, 'delOrSavePermission(data)');

            })
            /**************************启用权限结束*****************************/



            /**************************删除权限开始*****************************/
            $("#deletePermission").click(function(){
                var data = $("#detailRow")[0].data;
                var reqParam = {};
                if(data){
                    reqParam = {"opt":"delete","functionId":data.functionId}
                };
                //globalFunctionId = $("#detailRow")[0].data.parentApplicationId;//删除时候存储父级id;
                getAjaxResult("/functionManage/verificationDeleteFunction", "post", reqParam, 'deleteWarn(data)');

            });
            /**************************删除权限结束*****************************/
        });
        function initZz(data){
            data = JSON.parse(data).rspBody.children;
            console.log(data)
            if((data.length>0 && data[0].children.length>0)||(data.length>1)){
                var a = new treeCheck();
                a.loopLoad({"data":data, "parentDom":$("#looptree2"),"parentId":"looptree2","showName":"orgName"});
                $("#looptree2").treeview();
                openWin(400, 220, "chooseZz", true);

            }else{
                initTree(orgId);
            }
        }

        function initTree(orgId){
            if(orgId){
                orgId = orgId;
            }else{
                orgId = "";
            }
            getAjaxResult("/functionManage/functionManageList", "post", {"orgIdAll":orgId,"parentApplicationName":""}, 'initTreeList(data,"looptree")');
        }
        function setValue4DescProcess(jsonItem, key,jsonData) {
            if(key == "status"){
                if(jsonItem[key]){
                    $("#resourchSe input").prop("checked",true)
                }else{
                    $("#resourchSe input").prop("checked",false)
                }
            }
            console.log(key)
        }



        /***********************编辑权限结束****************************/

        function setStatus(dom){
            if($("#"+dom)[0].data){
                if($("#" + dom + " #status").prop("checked")){

                    $("#"+dom)[0].data.status = 1;
                }else{
                    $("#"+dom)[0].data.status = 0;
                }
            }
        }

        function delOrSavePermission(data){
            data = JSON.parse(data)
            console.log(data)
            if(data.rspBody.opt == "insert" || data.rspBody.opt == "update"){//新建//编辑

                globalFunctionId = data.rspBody.functionId;

            }else if(data.rspBody.opt == "delete"){//删除

                globalFunctionId = data.rspBody.parentApplicationId;

            }

            if(data.retCode ==  "0000000")initTree();//操作成功之后初始化tree树
            
            setStatus("detailRow")
            alert(data.retDesc)
            closePopupWin();
        }
        function deleteWarn(data){
            var a = new clsAlertBoxCtrl();
            a.Alert(JSON.parse(data).retDesc,"删除提示",true);
        }

        //点击确认执行的方法
        function clsAlertBoxCtrl$sure() {

            var data = $("#detailRow")[0].data;
            var reqParam = {};
            if(data){
                reqParam = {"opt":"delete","functionId":data.functionId}
            };


            //globalFunctionId = $("#detailRow")[0].data.parentApplicationId;//删除时候存储父级id;
            getAjaxResult("/functionManage/keepFunctionManage", "post", reqParam, 'delOrSavePermission(data)');
            //删除的时候默认父级id选中
            //initTree();
        }
            
        function initTreeList(data,id,isNeedCheck) {//初始化加载权限tree
            //data 请求的数据, id 最外层id, idneedcheck是否有checkbox
                data = JSON.parse(data).rspBody.resultData;
                if(data.length == 0){
                    $(".resource").show();
                    $(".resourceAd").hide();
                    $("#detailRow")[0].data = null;
                }else{
                    $(".resource").hide();
                    $(".resourceAd").show();
                    var a = new treeCheck();


                    a.loopLoad({"data":data, "parentDom":$("#"+id), "isNeedCheck":isNeedCheck, "parentId":id,"showName":"functionTitle"});
                    a.unionChecked("input[type=checkbox]");

                    $("#looptree .cloneTreeA").click(function(){//alert(1)
                        $(".resourceAd-con-left a").removeClass("domTreeActive");
                        $(this).addClass("domTreeActive");
                        $("#createNewPermission").show();
                        $("#deletePermission").show();
                        $("#editPermission").show();
                        $("#detailRow").show();
                        $("#detailRow")[0].data = $(this).parent("li")[0].data;
                        setValue4Desc($(this).parent("li")[0].data, $("#detailRow")[0])
                        //functionTitle url
                    });

                    $("#" + id + " #navigation").treeview();


                    // for(var i=0;i<$("#" + id + " #navigation li").length;i++){//模拟点击

                    //     if($("#" + id + " #navigation li").eq(i)[0].data.functionId == globalFunctionId){
                    //         $("#" + id + " #navigation li").eq(i).find(".cloneTreeA").click();
                    //     };

                    // }
                }
        }

    </script>
</head>
<body>
    <div class="resource" style="display:none">
        <div class="resource-div">
            <img src="../images/resource.png"/>
            <span>
                暂无权限、
            </span>
            <a href="javascript:;" >
                <span id="addPermission" style="color:#5accc6">添加</span>权限
            </a>
        </div>
    </div>
    <div class="resourceAd" style="display:none">
        <!-- <div class="resourceAd-head">
            <input type="text" class="resourceAd-head-in"/>
            <a href="javascript:;" class="resourceAd-head-a">查询</a>
        </div> -->
        <div class="resourceAd-con">
            <div class="resourceAd-con-left">
                <div class="left-div">
                    <span class="left-div-fir">权限分类</span>
                    <a href="javascript:;" class="left-div-two" id="root">根目录</a>
                </div>

                <div id="looptree">
                </div>

            </div>
            <div class="resourceAd-con-right">
                <div class="right-head">

                </div>
                <div class="right-con">
                    <div class="right-con-div">
                        <a href="javascript:;" class="div-a-add" id="createNewPermission" style="display:none"><i class="add-i"></i><span>新建</span></a>
                        <a href="javascript:;" class="div-a-add" id="deletePermission" style="display:none"><i class="add-i del-i"></i><span>删除</span></a>
                        <a href="javascript:;" class="div-a-add" id="editPermission" style="display:none"><i class="add-i com-i"></i><span>编辑</span></a>
                    </div>
                    <!-- <div class="right-con-tit">
                        <span>权限列表</span>
                        <span>权限操作</span>
                    </div> -->
                    <div class="right-con-fot">

                        <ul id="detailRow" class="fot-ul" style="display:none">
                            <li class="fot-ul-img"><img src="../images/set.png"></li>
                            <li><span>功能名称：</span><span class="fot-ul-span" id="functionTitle"></span></li>
                            <li><span>功能类型：</span><span class="fot-ul-span" id="functionType"></span></li>
                            <li><span>功能ID：</span><span class="fot-ul-span" id="functionId"></span></li>
                            <li><span>功能描述：</span><span class="fot-ul-span" id="functionDesc"></span></li>
                            <li><span>功能编码：</span><span class="fot-ul-span" id="functionCode"></span></li>
                            <li><span>父级功能名称：</span><span class="fot-ul-span" id="parentApplicationName"></span></li>
                            <li><span>是否启用：</span><input type="checkbox" id="status"></li>

                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>



<div id="resourchSe" class="popup" style="display:none">
    <div class="title"><h2>新增权限</h2>
            <div>
                <a class="min" href="javascript:;" title="最小化" style="display:none;"></a>
                <a class="max" href="javascript:;" title="最大化" style="display:none;"></a>
                <a class="revert" href="javascript:;" title="还原" style="display:none;"></a>
                <a class="close" href="javascript:;" title="关闭"></a>
            </div>
    </div>
    <div class="content" style="height: 180px;">
        <div class="resourchSe" style="padding:0 30px;">
            <ul class="resourchSe-ul">
                <li><label>名称：</label><input type="text" class="required" id="functionTitle"/></li>
                <li><label>路径：</label><input type="text" class="required" id="functionPath"/></li>
                <li style="position:relative;display:none"><label>选择组织：</label><!-- <input type="text" id="orgId" class="required"/> -->

                    <div type="text" class="userNewPopup-ulist-list-input" id="selectOrganization"></div>
                    <div class="userNewPopup-ulist-listPopup" id="selectOrganizationPopup" style="display: none;">
                        <div>
                            <ul class="userNewPopup-ulist-listBox" id="organizationList"  templateId="templateRow" reqPath="" reqParam="" method="POST">
                                <li class="userNewPopup-ulListBox-list" id="orgSelectDetail" style="height: auto;min-height: 30px;">
                                    当前组织：
                                    <span id="templateList" style="display: none;">
                                        <span id="orgNameShow"></span>
                                        <b id="orgNameShowDelete" class="userNewPopup-ulListBox-list-delete">X</b>
                                    </span>
                                </li>
                                <li class="userNewPopup-ulListBox-list" id="templateRow" style="display: none;"><span id="orgName"></span></li>
                                <li class="userNewPopup-ulListBox-list" id="orgSelectDetail">
                                    <div class="userNewPopup-ulListBox-list-btn" id="organizationSelectSure">确认</div>
                                </li>
                            </ul>
                        </div>
                    </div>
                </li>
                <li><label>默认启用：</label><input type="checkbox" checked id="status"/></li>
            </ul>
            <!-- <div class="mod-search-div">
                <a href="javascript:;" class="mod-searchBtn ml20"><span>确定</span></a>
            </div> -->
        </div>
        <div class="btn">
            <a href="javascript:" class="btnOne btnStyle1 mr10" id="creatPermi">确定</a>
            <a href="javascript:" class="btnSecond btnStyle1_1" id="cancelPermi">取消</a>
        </div>
    </div>
</div>

<!-- <div id="editPermissionAlert" class="popup" style="display:none">
    <div class="title"><h2>编辑该权限</h2>
            <div>
                <a class="min" href="javascript:;" title="最小化" style="display:none;"></a>
                <a class="max" href="javascript:;" title="最大化" style="display:none;"></a>
                <a class="revert" href="javascript:;" title="还原" style="display:none;"></a>
                <a class="close" href="javascript:;" title="关闭"></a>
            </div>
    </div>
    <div class="content" style="height: 180px;">
        <div id="looptree1"></div>
        <div class="btn">
            <a href="javascript:" class="btnOne btnStyle1 mr10" id="savePermiEdit">保存</a>
            <a href="javascript:" class="btnSecond btnStyle1_1" id="cancelPermiEdit">取消</a>
        </div>
    </div>
</div> -->

<!-- <div class="resourchSe" id="resourchSe" style="display:none">
    <ul class="resourchSe-ul">
        <li><label>名称：</label><input type="text"/></li>
        <li><label>路径：</label><input type="text"/></li>
        <li><label>选择组织：</label><input type="text"/></li>
        <li><label>默认启用：</label><input type="checkbox"/></li>
    </ul>
    <div class="mod-search-div">
        <a href="javascript:;" class="mod-searchBtn ml20"><span>确定</span></a>
    </div>
</div> -->
<div class="resourceSet" style="display:none">
    <ul class="resourceSet-ul">
        <li><span>有效时间：</span><span>2018年1月1日</span></li>
        <li><span>有效时间：</span><span>2018年1月1日</span></li>
        <li><span>有效时间：</span><span>2018年1月1日</span></li>

    </ul>
    <div class="mod-search-div">
        <a href="javascript:;" class="mod-searchBtn ml20"><span>删除</span></a>
        <a href="javascript:;" class="mod-searchBtn ml20"><span>关闭</span></a>
    </div>
</div>
<!-- 选择组织弹窗-->
<div id="chooseZz" class="popup" style="display:none">
    <div class="title"><h2>选择组织</h2>
            <div>
                <a class="min" href="javascript:;" title="最小化" style="display:none;"></a>
                <a class="max" href="javascript:;" title="最大化" style="display:none;"></a>
                <a class="revert" href="javascript:;" title="还原" style="display:none;"></a>
                <a class="close" href="javascript:;" title="关闭" style="display:none;"></a>
            </div>
    </div>
    <div class="content" style="height: 180px;">
        <div id="looptree2">
            
        </div>
        <div class="btn">
            <p class="tl"><span style="color:red">*</span>如果不选择组织，将直接显示该用户默认关联的组织下数据</p>
            <a href="javascript:" class="btnOne btnStyle1 mr10" id="czSureBtn">确定</a>
            <!-- <a href="javascript:" class="btnSecond btnStyle1 mr10" id="czCancelBtn">取消</a> -->
        </div>
    </div>
</div>
</body>
</html>